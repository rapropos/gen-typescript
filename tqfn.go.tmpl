{{ define "tqfn" }}

{{- $watchMethod := .watchMethod }}
{{- $methodMap := .MethodMap }}
{{- $argsVarName := .argsVarName }}
{{- if not $argsVarName }}
{{      $argsVarName = "args" }}
{{- end}}

{{- $tsmn := firstLetterToLower $watchMethod.Name }}

{{- $baseName := trimPrefix $watchMethod.Name "Watch" }}
{{- $tsbn := firstLetterToLower $baseName }}

{{- $hasInput := gt (len $watchMethod.Inputs) 0}}

{{- $out := false }}
{{- $outTypeName := false }}
{{- $isOutSlice := false }}
{{- $isOutStub := false }}
{{- $isOutUncertain := false }}
{{- $outTypeBaseName := false }}
{{- $ribFetchFieldName := false }}
{{- $automaticLastValidFallback := false }}

{{- $hasOutput := gt (len $watchMethod.Outputs) 0}}
{{- if $hasOutput }}
{{-     $out = index $watchMethod.Outputs 0}}
{{-     $outTypeName = $out.Type.Expr }}
{{-     $isOutSlice = hasPrefix $outTypeName "[]"}}
{{-     $isOutStub = hasSuffix $outTypeName "Stub"}}
{{-     $isOutUncertain = $out.Optional }}
{{-     $outTypeBaseName = trimSuffix (trimPrefix $outTypeName "[]") "Stub" }}
{{-     $ribFetchFieldName = firstLetterToLower $outTypeBaseName }}
{{- end }}

{{- $lastValidBackupMn := print "LastValid" $baseName }}
{{- $lastValidBackupExists := hasKey $methodMap $lastValidBackupMn}}
{{- $byIdEnsurerFnm := print "ensure" $outTypeBaseName "ById"}}
{{- $byIdFetcherFnm := print "watch" $outTypeBaseName "ById" -}}

mama.{{$tsmn}}({{if $hasInput}}{{$argsVarName}}{{end}})
{{- if eq (len $watchMethod.Outputs) 1}}
{{-     if all $automaticLastValidFallback $isOutUncertain $lastValidBackupExists }}
    .then(rpc => {
        return rpc.{{$ribFetchFieldName}}
            ?? mama.{{firstLetterToLower $lastValidBackupMn}}({{$argsVarName}})
			    .then(lvrpc => lvrpc.{{$ribFetchFieldName}});
	})
{{-     else if $out}}
    .then(rpc => rpc.{{$out.Name}})
{{-     end}}
{{- end }}
{{- end }}
