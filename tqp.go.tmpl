{{ define "tqp" }}
// TQP IN
{{- $service := .service }}
{{- $method := .Method }}
{{- $methodMap := .MethodMap }}
{{- $typeMap := .TypeMap}}

{{- $baseName := trimPrefix $method.Name "Watch" }}
{{- $tsbn := firstLetterToLower $baseName }}

{{- $hasInput := gt (len $method.Inputs) 0}}

{{- $out := false }}
{{- $outTypeName := false }}
{{- $isOutSlice := false }}
{{- $isOutStub := false }}
{{- $isOutUncertain := false }}
{{- $outTypeBaseName := false }}
{{- $ribFetchFieldName := false }}

{{- $hasOutput := gt (len $method.Outputs) 0}}
{{- if $hasOutput }}
{{-     $out = index $method.Outputs 0}}
{{-     $outTypeName = $out.Type.Expr }}
{{-     $isOutSlice = hasPrefix $outTypeName "[]"}}
{{-     $isOutStub = hasSuffix $outTypeName "Stub"}}
{{-     $isOutUncertain = $out.Optional }}
{{-     $outTypeBaseName = trimSuffix (trimPrefix $outTypeName "[]") "Stub" }}
{{-     $ribFetchFieldName = firstLetterToLower $outTypeBaseName }}
{{- end }}

{{- $lastValidBackupMn := print "LastValid" $baseName }}
{{- $lastValidBackupExists := hasKey $methodMap $lastValidBackupMn}}
{{- $byIdEnsurerFnm := print "ensure" $outTypeBaseName "ById"}}
{{- $byIdFetcherFnm := print "watch" $outTypeBaseName "ById"}}

export function ensure{{$baseName}}({tqc, mama{{if $hasInput}}, args{{end}}}: {tqc: QueryClient, mama: {{$service.Name}}{{if $hasInput}}, args: {{$baseName}}Args{{end}}}) {
    return tqc.ensureQueryData({
        queryKey: {{$tsbn}}Tqk{{if $hasInput}}(args){{end}},
        queryFn: () => {{template "tqfn" dict "Method" $method "MethodMap" $methodMap "TypeMap" $typeMap}},
    });
}

{{- if $hasOutput}}
{{-     if $isOutStub}}
{{-         if hasKey $methodMap (firstLetterToUpper $byIdFetcherFnm)}}

export function ensureFull{{$baseName}}({tqc, mama{{if $hasInput}}, args{{end}}}: {tqc: QueryClient, mama: {{$service.Name}}{{if $hasInput}}, args: {{$baseName}}Args{{end}}}) {
    return ensure{{$baseName}}({tqc, mama{{if $hasInput}}, args{{end}}})
{{-             if $isOutSlice }}.then(tqrv => Promise.all(tqrv.{{$out.Name}}.map(stub => {{$byIdEnsurerFnm}}({tqc, mama, args: { {{- $ribFetchFieldName}}Id: stub.id}}))));
{{-             else if $out.Optional }}.then(tqrv => tqrv?.{{$out.Name}} ? {{$byIdEnsurerFnm}}({tqc, mama, args: { {{- $ribFetchFieldName}}Id: tqrv.{{$out.Name}}.id}}) : undefined);
{{-             else }}.then(stub => {{$byIdEnsurerFnm}}({tqc, mama, args: {
                                {{- $ribFetchFieldName}}Id: stub.id}}));
{{-             end }}
}
{{-        else }}
// no rib query {{$byIdEnsurerFnm}} available
{{-        end}}
{{-     end}}
{{- end }}
// TQP OUT
{{- end }}